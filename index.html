<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ma Cave √† Alcools Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #8f5e26; --primary-dark: #6d4419; --secondary: #c49a6c;
      --bg: #1a1a1a; --bg-card: #2a2a2a; --text: #e0e0e0; --text-dim: #a0a0a0;
      --success: #4caf50; --warning: #ff9800; --danger: #f44336;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    header { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); padding: 1.5rem 0; box-shadow: 0 2px 10px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 100; }
    header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    h1 { font-size: 1.8rem; display: flex; align-items: center; gap: 0.5rem; }
    .user-info { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    button { background: var(--primary); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.3s; font-weight: 500; }
    button:hover { background: var(--primary-dark); transform: translateY(-2px); }
    .btn-secondary { background: var(--bg-card); border: 1px solid var(--secondary); }
    .btn-danger { background: var(--danger); }
    input, select, textarea { width: 100%; padding: 0.8rem; margin-bottom: 1rem; background: var(--bg); border: 1px solid #444; border-radius: 8px; color: var(--text); font-size: 1rem; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
    .tabs { display: flex; gap: 0.5rem; margin: 2rem 0; border-bottom: 2px solid #333; overflow-x: auto; }
    .tab { padding: 0.8rem 1.5rem; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.3s; white-space: nowrap; }
    .tab.active { border-bottom-color: var(--primary); color: var(--primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; }
    .stat-card { background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid #333; }
    .stat-value { font-size: 2rem; font-weight: bold; color: var(--primary); margin: 0.5rem 0; }
    .stat-label { color: var(--text-dim); font-size: 0.9rem; }
    .chart-container { background: var(--bg-card); padding: 2rem; border-radius: 12px; margin: 2rem 0; border: 1px solid #333; }
    .bottles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
    .bottle-card { background: var(--bg-card); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.3s; cursor: pointer; border: 1px solid #333; }
    .bottle-card:hover { transform: translateY(-5px); box-shadow: 0 8px 24px rgba(143, 94, 38, 0.3); }
    .bottle-image { height: 200px; background: linear-gradient(135deg, #2a2a2a, #3a3a3a); display: flex; align-items: center; justify-content: center; font-size: 4rem; position: relative; overflow: hidden; }
    .bottle-image img { width: 100%; height: 100%; object-fit: cover; }
    .bottle-status { position: absolute; top: 10px; right: 10px; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
    .status-scellee { background: var(--success); }
    .status-ouverte { background: var(--warning); }
    .status-vide { background: var(--danger); }
    .bottle-alert { position: absolute; top: 10px; left: 10px; background: var(--danger); padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .bottle-content { padding: 1.5rem; }
    .bottle-name { font-size: 1.3rem; font-weight: bold; margin-bottom: 0.5rem; color: var(--secondary); }
    .bottle-type { color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem; }
    .progress-bar { width: 100%; height: 8px; background: #333; border-radius: 10px; overflow: hidden; margin: 1rem 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.3s; }
    .bottle-details { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-dim); margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #333; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; padding: 2rem; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: var(--bg-card); padding: 2rem; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .close-btn { background: transparent; font-size: 2rem; padding: 0; width: 40px; height: 40px; border-radius: 50%; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; color: var(--secondary); font-weight: 500; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .actions { display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end; flex-wrap: wrap; }
    .image-upload { border: 2px dashed #444; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: border-color 0.3s; }
    .image-upload:hover { border-color: var(--primary); }
    .image-preview { max-width: 100%; max-height: 200px; margin-top: 1rem; border-radius: 8px; }
    .fab { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s; z-index: 99; }
    .fab:hover { transform: scale(1.1) rotate(45deg); }
    .fab-menu { position: fixed; bottom: 5rem; right: 2rem; display: none; flex-direction: column; gap: 0.5rem; z-index: 98; }
    .fab-menu.active { display: flex; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fab-item { background: var(--bg-card); padding: 0.8rem 1rem; border-radius: 30px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: all 0.3s; border: 1px solid var(--primary); white-space: nowrap; }
    .fab-item:hover { background: var(--primary); transform: translateX(-5px); }
    .alert-card { background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin: 1rem 0; border-left: 4px solid var(--warning); }
    .notification { position: fixed; top: 5rem; right: 2rem; background: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 1001; animation: slideIn 0.3s; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @media (max-width: 768px) { h1 { font-size: 1.3rem; } .bottles-grid { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } .modal { padding: 1rem; } }
  </style>
</head>
<body>
  <div id="authScreen" style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, #1a1a1a 0%, #2a2020 100%);">
    <div style="background:var(--bg-card);padding:2rem;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.4);width:100%;max-width:400px;">
      <h2 style="margin-bottom:1.5rem;text-align:center;color:var(--secondary);">üç∑ Ma Cave √† Alcools</h2>
      <input type="email" id="authEmail" placeholder="Email" required>
      <input type="password" id="authPassword" placeholder="Mot de passe" required>
      <button onclick="login()" style="width:100%;margin-bottom:0.5rem">Se connecter</button>
      <button onclick="signup()" class="btn-secondary" style="width:100%">Cr√©er un compte</button>
      <div id="authError" style="color:var(--danger);margin-top:1rem;text-align:center;"></div>
    </div>
  </div>

  <div id="mainApp" style="display:none">
    <header>
      <div class="container">
        <h1>üç∑ Ma Cave Pro</h1>
        <div class="user-info">
          <button onclick="exportPDF()">üìÑ</button>
          <button onclick="exportExcel()">üìä</button>
          <button onclick="logout()" class="btn-danger">D√©connexion</button>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('collection')">üìö Collection</button>
        <button class="tab" onclick="switchTab('stats')">üìä Statistiques</button>
        <button class="tab" onclick="switchTab('alerts')">üîî Alertes</button>
        <button class="tab" onclick="switchTab('account')">üë§ Compte</button>
      </div>

      <div id="collectionTab" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label">Total bouteilles</div><div class="stat-value" id="statTotal">0</div></div>
          <div class="stat-card"><div class="stat-label">Valeur totale</div><div class="stat-value" id="statValue">0 ‚Ç¨</div></div>
          <div class="stat-card"><div class="stat-label">Volume restant</div><div class="stat-value" id="statVolume">0 L</div></div>
          <div class="stat-card"><div class="stat-label">Bouteilles ouvertes</div><div class="stat-value" id="statOpen">0</div></div>
        </div>
        <div style="display:flex;gap:1rem;margin:2rem 0;flex-wrap:wrap;">
          <input type="text" id="searchInput" placeholder="üîç Rechercher..." oninput="filterBottles()" style="flex:1;min-width:200px;">
          <select id="filterType" onchange="filterBottles()">
            <option value="">Tous les types</option>
            <option value="vin">Vin</option><option value="whisky">Whisky</option><option value="rhum">Rhum</option>
            <option value="vodka">Vodka</option><option value="gin">Gin</option><option value="biere">Bi√®re</option>
            <option value="champagne">Champagne</option><option value="liqueur">Liqueur</option>
          </select>
          <select id="filterStatus" onchange="filterBottles()">
            <option value="">Tous les statuts</option>
            <option value="scellee">Scell√©e</option><option value="ouverte">Ouverte</option><option value="vide">Vide</option>
          </select>
        </div>
        <div id="bottlesContainer" style="text-align:center;padding:3rem;">Chargement...</div>
      </div>

      <div id="statsTab" class="tab-content">
        <div class="chart-container"><h3>R√©partition par type</h3><canvas id="typeChart"></canvas></div>
        <div class="chart-container"><h3>Top 10 par valeur</h3><canvas id="topChart"></canvas></div>
      </div>

      <div id="alertsTab" class="tab-content">
        <h2 style="margin-bottom:1.5rem">üîî Alertes</h2>
        <div id="alertsContainer"></div>
      </div>

      <div id="accountTab" class="tab-content">
        <h2 style="margin-bottom:1.5rem">üë§ Mon compte</h2>
        <div class="chart-container">
          <h3>Informations</h3>
          <div class="form-group"><label>Email</label><input type="email" id="profileEmail" readonly style="background:#333;"></div>
          <div class="form-group"><label>R√¥le</label><input type="text" id="profileRole" readonly style="background:#333;"></div>
        </div>
        <div class="chart-container" style="margin-top:2rem;">
          <h3>Changer le mot de passe</h3>
          <div class="form-group"><label>Nouveau mot de passe</label><input type="password" id="newPassword" placeholder="Min. 6 caract√®res"></div>
          <div class="form-group"><label>Confirmer</label><input type="password" id="confirmPassword"></div>
          <button onclick="changePassword()">Changer</button>
        </div>
      </div>
    </div>

    <div class="fab-menu" id="fabMenu">
      <div class="fab-item" onclick="openAddModal();closeFabMenu()">‚ûï Ajouter</div>
      <div class="fab-item" onclick="openScanModal();closeFabMenu()">üì∑ Scanner</div>
    </div>
    <div class="fab" onclick="toggleFabMenu()">+</div>

    <div id="bottleModal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><h2 id="modalTitle">Ajouter une bouteille</h2><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="bottleForm" onsubmit="saveBottle(event)">
          <div class="form-group">
            <label>üì∏ Photo</label>
            <div class="image-upload" onclick="document.getElementById('photoInput').click()">
              <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="previewImage(event)">
              <div id="uploadText">Cliquez pour ajouter</div>
              <img id="imagePreview" class="image-preview" style="display:none">
            </div>
          </div>
          <div class="form-group"><label>Nom *</label><input type="text" id="inputNom" required></div>
          <div class="form-group">
            <label>üì∑ Code-barre</label>
            <input type="text" id="inputCodeBarre" placeholder="Ex: 3760074380213" style="font-family:monospace;letter-spacing:2px;">
          </div>
          <div class="form-row">
            <div class="form-group"><label>Type *</label>
              <select id="inputType" required>
                <option value="vin">Vin</option><option value="whisky">Whisky</option><option value="rhum">Rhum</option>
                <option value="vodka">Vodka</option><option value="gin">Gin</option><option value="cognac">Cognac</option>
                <option value="biere">Bi√®re</option><option value="champagne">Champagne</option><option value="liqueur">Liqueur</option>
                <option value="Pastis">Pastis</option>
              </select>
            </div>
            <div class="form-group"><label>Degr√© (%)</label><input type="number" id="inputDegre" step="0.1" min="0" max="100"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Volume (ml) *</label><input type="number" id="inputVolume" required placeholder="Ex: 750"></div>
            <div class="form-group"><label>Nombre</label><input type="number" id="inputNombre" value="1" min="1"></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Statut *</label>
              <select id="inputStatut" required>
                <option value="scellee">üîí Scell√©e (non ouverte)</option>
                <option value="ouverte">üçæ Ouverte (entam√©e)</option>
                <option value="vide">‚ùå Vide (termin√©e)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Restant (%)</label>
              <input type="number" id="inputPourcentage" min="0" max="100" value="100" placeholder="100">
              <small style="display:block;color:var(--text-dim);margin-top:0.3rem;font-size:0.85rem;">100% = pleine, 50% = moiti√©, 0% = vide</small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Prix (‚Ç¨)</label><input type="number" id="inputPrix" step="0.01" min="0"></div>
            <div class="form-group"><label>Date achat</label><input type="date" id="inputDateAchat"></div>
          </div>
          <div class="form-group"><label>Pays / R√©gion</label><input type="text" id="inputPays"></div>
          <div class="form-group"><label>Mill√©sime</label><input type="number" id="inputMillesime" min="1900" max="2030"></div>
          <div class="form-group"><label>Commentaire</label><textarea id="inputCommentaire" rows="3"></textarea></div>
          <div class="actions">
            <button type="button" onclick="deleteBottle()" class="btn-danger" id="deleteBtn" style="display:none">Supprimer</button>
            <button type="button" onclick="closeModal()" class="btn-secondary">Annuler</button>
            <button type="submit">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>

    <div id="scanModal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><h2>üì∑ Scanner</h2><button class="close-btn" onclick="closeScanModal()">√ó</button></div>
        <video id="scannerVideo" style="width:100%;max-width:400px;border-radius:8px;background:#000;"></video>
        <div id="scanResult" style="margin-top:1rem;color:var(--success);"></div>
        <button onclick="closeScanModal()" class="btn-secondary" style="margin-top:1rem;width:100%;">Annuler</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null, allBottles = [], editingBottleId = null, uploadedPhoto = null, scannerStream = null, codeReader = null, charts = {};

    async function init() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      session ? (currentUser = session.user, showMainApp()) : showAuthScreen();
      supabaseClient.auth.onAuthStateChange((e, s) => s ? (currentUser = s.user, showMainApp()) : showAuthScreen());
    }
    function showAuthScreen() { document.getElementById('authScreen').style.display = 'flex'; document.getElementById('mainApp').style.display = 'none'; }
    function showMainApp() { document.getElementById('authScreen').style.display = 'none'; document.getElementById('mainApp').style.display = 'block'; loadBottles(); checkAlerts(); }
    async function signup() { const { error } = await supabaseClient.auth.signUp({ email: document.getElementById('authEmail').value, password: document.getElementById('authPassword').value }); document.getElementById('authError').textContent = error ? error.message : '‚úÖ Compte cr√©√© !'; }
    async function login() { const { error } = await supabaseClient.auth.signInWithPassword({ email: document.getElementById('authEmail').value, password: document.getElementById('authPassword').value }); if (error) document.getElementById('authError').textContent = error.message; }
    async function logout() { await supabaseClient.auth.signOut(); window.location.reload(); }

    async function loadBottles() {
      const { data, error } = await supabaseClient.from('bouteilles').select('*').order('created_at', { ascending: false });
      if (error) return console.error(error);
      allBottles = data || [];
      displayBottles(allBottles);
      updateStats(allBottles);
    }

    function displayBottles(bottles) {
      const c = document.getElementById('bottlesContainer');
      if (!bottles.length) { c.innerHTML = '<div style="padding:4rem;"><div style="font-size:5rem;">üçæ</div><h2>Cave vide</h2></div>'; return; }
      c.innerHTML = ''; c.className = 'bottles-grid';
      bottles.forEach(b => {
        const percent = (b.volume_restant_ml / b.volume_ml * 100).toFixed(0);
        const emoji = {vin:'üç∑',whisky:'ü•É',rhum:'ü•É',vodka:'üç∏',gin:'üç∏',biere:'üç∫',champagne:'üçæ',liqueur:'üçπ',cognac:'ü•É'}[b.type_alcool]||'üçæ';
        c.innerHTML += `<div class="bottle-card" onclick='openEditModal(${JSON.stringify(b).replace(/'/g,"&apos;")})'>
          <div class="bottle-image">${b.photo_url?`<img src="${b.photo_url}">`:`${emoji}`}<div class="bottle-status status-${b.statut}">${b.statut}</div></div>
          <div class="bottle-content"><div class="bottle-name">${b.nom}</div><div class="bottle-type">${b.type_alcool.toUpperCase()}</div>
          <div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div>
          <div class="bottle-details"><span>${b.volume_restant_ml}/${b.volume_ml}ml</span><span>${b.nombre_bouteilles}x</span>${b.prix_achat?`<span>${b.prix_achat}‚Ç¨</span>`:''}</div></div></div>`;
      });
    }

    function filterBottles() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const type = document.getElementById('filterType').value;
      const status = document.getElementById('filterStatus').value;
      displayBottles(allBottles.filter(b => (!search||b.nom.toLowerCase().includes(search))&&(!type||b.type_alcool===type)&&(!status||b.statut===status)));
    }

    function updateStats(bottles) {
      document.getElementById('statTotal').textContent = bottles.length;
      document.getElementById('statValue').textContent = bottles.reduce((s,b)=>s+(b.prix_achat||0)*b.nombre_bouteilles,0).toFixed(2)+' ‚Ç¨';
      document.getElementById('statVolume').textContent = (bottles.reduce((s,b)=>s+b.volume_restant_ml,0)/1000).toFixed(1)+' L';
      document.getElementById('statOpen').textContent = bottles.filter(b=>b.statut==='ouverte').length;
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tab+'Tab').classList.add('active');
      if(tab==='stats') createCharts();
      if(tab==='alerts') checkAlerts();
      if(tab==='account') loadProfile();
    }

    function createCharts() {
      const types = {};
      allBottles.forEach(b => types[b.type_alcool] = (types[b.type_alcool]||0)+1);
      if(charts.type) charts.type.destroy();
      charts.type = new Chart(document.getElementById('typeChart'), {
        type:'doughnut',
        data:{ labels:Object.keys(types), datasets:[{ data:Object.values(types), backgroundColor:['#8f5e26','#c49a6c','#ff9800','#4caf50','#2196f3','#9c27b0'] }]},
        options:{ responsive:true, plugins:{ legend:{ labels:{ color:'#e0e0e0' }}}}
      });
      const sorted = [...allBottles].sort((a,b)=>(b.prix_achat||0)-(a.prix_achat||0)).slice(0,10);
      if(charts.top) charts.top.destroy();
      charts.top = new Chart(document.getElementById('topChart'), {
        type:'bar',
        data:{ labels:sorted.map(b=>b.nom.substring(0,20)), datasets:[{ label:'Prix (‚Ç¨)', data:sorted.map(b=>b.prix_achat||0), backgroundColor:'#8f5e26' }]},
        options:{ responsive:true, scales:{ y:{ticks:{color:'#e0e0e0'}}, x:{ticks:{color:'#e0e0e0'}}}}
      });
    }

    async function checkAlerts() {
      const alerts = [];
      allBottles.forEach(b => {
        if(b.statut==='ouverte'&&b.date_ouverture&&b.duree_conservation_jours) {
          const days = (new Date()-new Date(b.date_ouverture))/86400000;
          if(days >= b.duree_conservation_jours*0.8) alerts.push({text:`‚ö†Ô∏è ${b.nom} ouvert depuis ${Math.floor(days)} j
          padding:3rem;color:var(--text-dim);"><div style="font-size:4rem;">‚úÖ</div><h3>Aucune alerte</h3></div>';
    }

    function toggleFabMenu() {
      document.getElementById('fabMenu').classList.toggle('active');
    }
    function closeFabMenu() {
      document.getElementById('fabMenu').classList.remove('active');
    }

    function openAddModal() {
      editingBottleId = null;
      uploadedPhoto = null;
      document.getElementById('modalTitle').textContent = 'Ajouter une bouteille';
      document.getElementById('bottleForm').reset();
      document.getElementById('inputPourcentage').value = '100';
      document.getElementById('inputStatut').value = 'scellee';
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('uploadText').textContent = 'Cliquez pour ajouter';
      document.getElementById('deleteBtn').style.display = 'none';
      document.getElementById('bottleModal').classList.add('active');
    }

    function openEditModal(bottle) {
      editingBottleId = bottle.id;
      uploadedPhoto = null;
      document.getElementById('modalTitle').textContent = 'Modifier';
      
      const fields = {
        inputNom: bottle.nom,
        inputType: bottle.type_alcool,
        inputDegre: bottle.degre_alcool,
        inputVolume: bottle.volume_ml,
        inputNombre: bottle.nombre_bouteilles,
        inputStatut: bottle.statut,
        inputPourcentage: Math.round((bottle.volume_restant_ml / bottle.volume_ml) * 100),
        inputPrix: bottle.prix_achat,
        inputDateAchat: bottle.date_achat,
        inputPays: bottle.pays,
        inputMillesime: bottle.millesime,
        inputCommentaire: bottle.commentaire,
        inputCodeBarre: bottle.code_barre
      };
      
      Object.entries(fields).forEach(([id, value]) => {
        const field = document.getElementById(id);
        if (field) field.value = value || '';
      });
      
      const preview = document.getElementById('imagePreview');
      const uploadText = document.getElementById('uploadText');
      if (bottle.photo_url && preview) {
        preview.src = bottle.photo_url;
        preview.style.display = 'block';
        if (uploadText) uploadText.textContent = 'Modifier la photo';
      } else if (preview) {
        preview.style.display = 'none';
        if (uploadText) uploadText.textContent = 'Cliquez pour ajouter';
      }
      
      const deleteBtn = document.getElementById('deleteBtn');
      if (deleteBtn) deleteBtn.style.display = 'block';
      
      document.getElementById('bottleModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('bottleModal').classList.remove('active');
    }

    async function previewImage(e) {
      const file = e.target.files[0];
      if (!file) return;
      uploadedPhoto = file;
      const reader = new FileReader();
      reader.onload = (ev) => {
        document.getElementById('imagePreview').src = ev.target.result;
        document.getElementById('imagePreview').style.display = 'block';
        document.getElementById('uploadText').textContent = 'Modifier';
      };
      reader.readAsDataURL(file);
    }

    async function uploadPhoto(file) {
      const fileName = `${Date.now()}_${file.name}`;
      const { data, error } = await supabaseClient.storage.from('bouteilles-photos').upload(fileName, file);
      if (error) throw error;
      const { data: { publicUrl } } = supabaseClient.storage.from('bouteilles-photos').getPublicUrl(fileName);
      return publicUrl;
    }

    async function saveBottle(e) {
      e.preventDefault();
      
      let photoUrl = null;
      if (uploadedPhoto) {
        try {
          photoUrl = await uploadPhoto(uploadedPhoto);
        } catch (err) {
          console.error('Erreur photo:', err);
        }
      }

      const volumeMl = parseInt(document.getElementById('inputVolume')?.value || 0);
      const pourcentage = parseInt(document.getElementById('inputPourcentage')?.value || 100);
      const volumeRestantMl = Math.round((volumeMl * pourcentage) / 100);

      const bottleData = {
        nom: document.getElementById('inputNom')?.value || '',
        type_alcool: document.getElementById('inputType')?.value || 'vin',
        degre_alcool: document.getElementById('inputDegre')?.value ? parseFloat(document.getElementById('inputDegre').value) : null,
        volume_ml: volumeMl,
        volume_restant_ml: volumeRestantMl,
        nombre_bouteilles: parseInt(document.getElementById('inputNombre')?.value || 1),
        statut: document.getElementById('inputStatut')?.value || 'scellee',
        prix_achat: document.getElementById('inputPrix')?.value ? parseFloat(document.getElementById('inputPrix').value) : null,
        date_achat: document.getElementById('inputDateAchat')?.value || null,
        pays: document.getElementById('inputPays')?.value || null,
        millesime: document.getElementById('inputMillesime')?.value ? parseInt(document.getElementById('inputMillesime').value) : null,
        commentaire: document.getElementById('inputCommentaire')?.value || null,
        code_barre: document.getElementById('inputCodeBarre')?.value || null,
        user_id: currentUser.id
      };

      if (photoUrl) bottleData.photo_url = photoUrl;

      let error;
      if (editingBottleId) {
        delete bottleData.user_id;
        ({ error } = await supabaseClient.from('bouteilles').update(bottleData).eq('id', editingBottleId));
      } else {
        ({ error } = await supabaseClient.from('bouteilles').insert([bottleData]));
      }

      if (error) { alert('Erreur: ' + error.message); return; }
      
      showNotification(editingBottleId ? 'Mise √† jour !' : 'Ajout√©e !');
      closeModal();
      loadBottles();
    }

    async function deleteBottle() {
      if (!confirm('Supprimer ?')) return;
      const { error } = await supabaseClient.from('bouteilles').delete().eq('id', editingBottleId);
      if (error) { alert('Erreur: ' + error.message); return; }
      showNotification('Supprim√©e !');
      closeModal();
      loadBottles();
    }

    async function openScanModal() {
      document.getElementById('scanModal').classList.add('active');
      document.getElementById('scanResult').textContent = '';
      
      const video = document.getElementById('scannerVideo');
      
      try {
        scannerStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = scannerStream;
        await video.play();
        
        if (!codeReader) codeReader = new ZXing.BrowserBarcodeReader();
        
        codeReader.decodeFromVideoDevice(null, video, (result, err) => {
          if (result) {
            document.getElementById('scanResult').textContent = '‚úÖ ' + result.text;
            closeScanModal();
            setTimeout(() => searchProductByBarcode(result.text), 300);
          }
        });
      } catch (err) {
        alert('Erreur cam√©ra: ' + err.message);
        closeScanModal();
      }
    }

    function closeScanModal() {
      const video = document.getElementById('scannerVideo');
      if (video?.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
        video.srcObject = null;
      }
      if (scannerStream) {
        scannerStream.getTracks().forEach(t => t.stop());
        scannerStream = null;
      }
      if (codeReader) codeReader.reset();
      document.getElementById('scanModal').classList.remove('active');
    }

    async function searchProductByBarcode(code) {
      try {
        const res1 = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
        const data1 = await res1.json();
        if (data1.status === 1 && data1.product?.product_name) {
          const p = data1.product;
          openAddModal();
          setTimeout(() => {
            if (document.getElementById('inputNom')) document.getElementById('inputNom').value = p.product_name;
            if (document.getElementById('inputCodeBarre')) document.getElementById('inputCodeBarre').value = code;
            if (document.getElementById('inputDegre') && p.alcohol_100g) document.getElementById('inputDegre').value = p.alcohol_100g;
            if (p.image_url && document.getElementById('imagePreview')) {
              document.getElementById('imagePreview').src = p.image_url;
              document.getElementById('imagePreview').style.display = 'block';
            }
          }, 200);
          showNotification('‚úÖ Produit trouv√© !');
          return;
        }
      } catch (e) {}
      
      try {
        const res2 = await fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${code}`);
        const data2 = await res2.json();
        if (data2.items?.length > 0) {
          const item = data2.items[0];
          openAddModal();
          setTimeout(() => {
            if (document.getElementById('inputNom')) document.getElementById('inputNom').value = item.title;
            if (document.getElementById('inputCodeBarre')) document.getElementById('inputCodeBarre').value = code;
          }, 200);
          showNotification('‚úÖ Produit trouv√© !');
          return;
        }
      } catch (e) {}
      
      openAddModal();
      setTimeout(() => {
        if (document.getElementById('inputCodeBarre')) document.getElementById('inputCodeBarre').value = code;
      }, 200);
      showNotification('‚ö†Ô∏è Produit non trouv√©. Code: ' + code);
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(20);
      doc.text('Ma Cave', 105, 15, { align: 'center' });
      doc.setFontSize(10);
      doc.text(`${new Date().toLocaleDateString('fr-FR')}`, 105, 22, { align: 'center' });
      
      const tableData = allBottles.map(b => [
        b.nom,
        b.type_alcool,
        `${b.volume_restant_ml}/${b.volume_ml} ml`,
        b.nombre_bouteilles,
        b.prix_achat ? `${b.prix_achat} ‚Ç¨` : '-',
        b.statut
      ]);
      
      doc.autoTable({
        startY: 30,
        head: [['Nom', 'Type', 'Volume', 'Qt√©', 'Prix', 'Statut']],
        body: tableData,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [143, 94, 38] }
      });
      
      doc.save('ma-cave.pdf');
      showNotification('PDF export√© !');
    }

    function exportExcel() {
      const data = allBottles.map(b => ({
        Nom: b.nom,
        Type: b.type_alcool,
        'Degr√©': b.degre_alcool,
        'Volume (ml)': b.volume_ml,
        'Restant (ml)': b.volume_restant_ml,
        'Restant (%)': Math.round((b.volume_restant_ml / b.volume_ml) * 100),
        Quantit√©: b.nombre_bouteilles,
        Statut: b.statut,
        'Prix (‚Ç¨)': b.prix_achat,
        Pays: b.pays,
        Mill√©sime: b.millesime,
        'Code-barre': b.code_barre,
        Commentaire: b.commentaire
      }));
      
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ma Cave');
      XLSX.writeFile(wb, 'ma-cave.xlsx');
      showNotification('Excel export√© !');
    }

    function showNotification(text) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = text;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    async function loadProfile() {
      const { data } = await supabaseClient.from('profiles').select('*').eq('id', currentUser.id).single();
      if (data) {
        document.getElementById('profileEmail').value = data.email;
        document.getElementById('profileRole').value = data.role === 'admin' ? 'üëë Admin' : 'üë§ User';
      }
    }

    async function changePassword() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (newPassword.length < 6) { alert('Min. 6 caract√®res'); return; }
      if (newPassword !== confirmPassword) { alert('Mots de passe diff√©rents'); return; }
      
      const { error } = await supabaseClient.auth.updateUser({ password: newPassword });
      if (error) { alert('Erreur: ' + error.message); return; }
      
      showNotification('Mot de passe chang√© !');
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    init();
  </script>
</body>
</html>
