<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ma Cave √† Alcools Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #8f5e26; --primary-dark: #6d4419; --secondary: #c49a6c;
      --bg: #1a1a1a; --bg-card: #2a2a2a; --text: #e0e0e0; --text-dim: #a0a0a0;
      --success: #4caf50; --warning: #ff9800; --danger: #f44336;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    header { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); padding: 1.5rem 0; box-shadow: 0 2px 10px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 100; }
    header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    h1 { font-size: 1.8rem; display: flex; align-items: center; gap: 0.5rem; }
    .user-info { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    button { background: var(--primary); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.3s; font-weight: 500; }
    button:hover { background: var(--primary-dark); transform: translateY(-2px); }
    .btn-secondary { background: var(--bg-card); border: 1px solid var(--secondary); }
    .btn-danger { background: var(--danger); }
    input, select, textarea { width: 100%; padding: 0.8rem; margin-bottom: 1rem; background: var(--bg); border: 1px solid #444; border-radius: 8px; color: var(--text); font-size: 1rem; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
    .tabs { display: flex; gap: 0.5rem; margin: 2rem 0; border-bottom: 2px solid #333; overflow-x: auto; }
    .tab { padding: 0.8rem 1.5rem; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.3s; white-space: nowrap; }
    .tab.active { border-bottom-color: var(--primary); color: var(--primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; }
    .stat-card { background: var(--bg-card); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid #333; }
    .stat-value { font-size: 2rem; font-weight: bold; color: var(--primary); margin: 0.5rem 0; }
    .stat-label { color: var(--text-dim); font-size: 0.9rem; }
    .chart-container { background: var(--bg-card); padding: 2rem; border-radius: 12px; margin: 2rem 0; border: 1px solid #333; }
    .bottles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
    .bottle-card { background: var(--bg-card); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.3s; cursor: pointer; border: 1px solid #333; }
    .bottle-card:hover { transform: translateY(-5px); box-shadow: 0 8px 24px rgba(143, 94, 38, 0.3); }
    .bottle-image { height: 200px; background: linear-gradient(135deg, #2a2a2a, #3a3a3a); display: flex; align-items: center; justify-content: center; font-size: 4rem; position: relative; overflow: hidden; }
    .bottle-image img { width: 100%; height: 100%; object-fit: cover; }
    .bottle-status { position: absolute; top: 10px; right: 10px; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
    .status-scellee { background: var(--success); }
    .status-ouverte { background: var(--warning); }
    .status-vide { background: var(--danger); }
    .bottle-alert { position: absolute; top: 10px; left: 10px; background: var(--danger); padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .bottle-content { padding: 1.5rem; }
    .bottle-name { font-size: 1.3rem; font-weight: bold; margin-bottom: 0.5rem; color: var(--secondary); }
    .bottle-type { color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem; }
    .progress-bar { width: 100%; height: 8px; background: #333; border-radius: 10px; overflow: hidden; margin: 1rem 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.3s; }
    .bottle-details { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-dim); margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #333; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; padding: 2rem; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: var(--bg-card); padding: 2rem; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .close-btn { background: transparent; font-size: 2rem; padding: 0; width: 40px; height: 40px; border-radius: 50%; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; color: var(--secondary); font-weight: 500; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .actions { display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end; flex-wrap: wrap; }
    .image-upload { border: 2px dashed #444; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: border-color 0.3s; }
    .image-upload:hover { border-color: var(--primary); }
    .image-preview { max-width: 100%; max-height: 200px; margin-top: 1rem; border-radius: 8px; }
    .pairing-list { list-style: none; padding: 0; }
    .pairing-item { padding: 0.8rem; background: var(--bg); margin: 0.5rem 0; border-radius: 8px; border-left: 3px solid var(--primary); }
    .fab { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; border-radius: 50%; background: var(--primary); color: white; font-size: 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.3s; z-index: 99; }
    .fab:hover { transform: scale(1.1) rotate(45deg); }
    .fab-menu { position: fixed; bottom: 5rem; right: 2rem; display: none; flex-direction: column; gap: 0.5rem; z-index: 98; }
    .fab-menu.active { display: flex; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .fab-item { background: var(--bg-card); padding: 0.8rem 1rem; border-radius: 30px; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: all 0.3s; border: 1px solid var(--primary); white-space: nowrap; }
    .fab-item:hover { background: var(--primary); transform: translateX(-5px); }
    .alert-card { background: var(--bg-card); padding: 1.5rem; border-radius: 12px; margin: 1rem 0; border-left: 4px solid var(--warning); }
    .notification { position: fixed; top: 5rem; right: 2rem; background: var(--success); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 1001; animation: slideIn 0.3s; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @media (max-width: 768px) {
      h1 { font-size: 1.3rem; }
      .bottles-grid { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .modal { padding: 1rem; }
      .user-info button { font-size: 0.9rem; padding: 0.5rem 0.8rem; }
    }
  </style>
</head>
<body>
  <div id="authScreen" style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, #1a1a1a 0%, #2a2020 100%);">
    <div style="background:var(--bg-card);padding:2rem;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,0.4);width:100%;max-width:400px;">
      <h2 style="margin-bottom:1.5rem;text-align:center;color:var(--secondary);">üç∑ Ma Cave √† Alcools</h2>
      <input type="email" id="authEmail" placeholder="Email" required>
      <input type="password" id="authPassword" placeholder="Mot de passe" required>
      <button onclick="login()" style="width:100%;margin-bottom:0.5rem">Se connecter</button>
      <button onclick="signup()" class="btn-secondary" style="width:100%">Cr√©er un compte</button>
      <div id="authError" style="color:var(--danger);margin-top:1rem;text-align:center;"></div>
    </div>
  </div>

  <div id="mainApp" style="display:none">
    <header>
      <div class="container">
        <h1>üç∑ Ma Cave Pro</h1>
        <div class="user-info">
          <button onclick="exportPDF()" title="Exporter en PDF">üìÑ</button>
          <button onclick="exportExcel()" title="Exporter en Excel">üìä</button>
          <span id="userEmail" style="display:none;"></span>
          <button onclick="logout()" class="btn-danger">D√©connexion</button>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('collection')">üìö Collection</button>
        <button class="tab" onclick="switchTab('stats')">üìä Statistiques</button>
        <button class="tab" onclick="switchTab('alerts')">üîî Alertes</button>
        <button class="tab" onclick="switchTab('account')">üë§ Mon compte</button>
      </div>

      <div id="collectionTab" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label">Total bouteilles</div><div class="stat-value" id="statTotal">0</div></div>
          <div class="stat-card"><div class="stat-label">Valeur totale</div><div class="stat-value" id="statValue">0 ‚Ç¨</div></div>
          <div class="stat-card"><div class="stat-label">Volume restant</div><div class="stat-value" id="statVolume">0 L</div></div>
          <div class="stat-card"><div class="stat-label">Bouteilles ouvertes</div><div class="stat-value" id="statOpen">0</div></div>
        </div>
        <div style="display:flex;gap:1rem;margin:2rem 0;flex-wrap:wrap;">
          <input type="text" id="searchInput" placeholder="üîç Rechercher..." oninput="filterBottles()" style="flex:1;min-width:200px;">
          <select id="filterType" onchange="filterBottles()">
            <option value="">Tous les types</option>
            <option value="vin">Vin</option><option value="whisky">Whisky</option><option value="rhum">Rhum</option>
            <option value="vodka">Vodka</option><option value="gin">Gin</option><option value="biere">Bi√®re</option>
            <option value="champagne">Champagne</option><option value="liqueur">Liqueur</option>
          </select>
          <select id="filterStatus" onchange="filterBottles()">
            <option value="">Tous les statuts</option>
            <option value="scellee">Scell√©e</option><option value="ouverte">Ouverte</option><option value="vide">Vide</option>
          </select>
        </div>
        <div id="bottlesContainer" style="text-align:center;padding:3rem;color:var(--text-dim);">Chargement...</div>
      </div>

      <div id="statsTab" class="tab-content">
        <div class="chart-container"><h3>R√©partition par type</h3><canvas id="typeChart"></canvas></div>
        <div class="chart-container"><h3>√âvolution de la valeur</h3><canvas id="valueChart"></canvas></div>
        <div class="chart-container"><h3>Top 10 par valeur</h3><canvas id="topChart"></canvas></div>
      </div>

      <div id="alertsTab" class="tab-content">
        <h2 style="margin-bottom:1.5rem">üîî Alertes et notifications</h2>
        <div id="alertsContainer"></div>
      </div>

      <div id="accountTab" class="tab-content">
        <h2 style="margin-bottom:1.5rem">üë§ Mon compte</h2>
        
        <div class="chart-container">
          <h3>Informations du compte</h3>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="profileEmail" readonly style="background:#333;">
          </div>
          <div class="form-group">
            <label>Nom d'utilisateur</label>
            <input type="text" id="profileUsername" placeholder="Votre pseudo">
          </div>
          <div class="form-group">
            <label>R√¥le</label>
            <input type="text" id="profileRole" readonly style="background:#333;">
          </div>
          <button onclick="updateProfile()">Mettre √† jour le profil</button>
        </div>

        <div class="chart-container" style="margin-top:2rem;">
          <h3>Changer le mot de passe</h3>
          <div class="form-group">
            <label>Nouveau mot de passe</label>
            <input type="password" id="newPassword" placeholder="Min. 6 caract√®res">
          </div>
          <div class="form-group">
            <label>Confirmer le mot de passe</label>
            <input type="password" id="confirmPassword" placeholder="Retapez le mot de passe">
          </div>
          <button onclick="changePassword()">Changer le mot de passe</button>
        </div>

        <div class="chart-container" style="margin-top:2rem;border-color:var(--danger);">
          <h3 style="color:var(--danger);">Zone dangereuse</h3>
          <p style="color:var(--text-dim);margin:1rem 0;">La suppression de votre compte est irr√©versible.</p>
          <button onclick="deleteAccount()" class="btn-danger">Supprimer mon compte</button>
        </div>
      </div>
    </div>

    <div class="fab-menu" id="fabMenu">
      <div class="fab-item" onclick="openAddModal();closeFabMenu()">‚ûï Ajouter manuellement</div>
      <div class="fab-item" onclick="openScanModal();closeFabMenu()">üì∑ Scanner code-barre</div>
    </div>
    <div class="fab" id="fabBtn" onclick="toggleFabMenu()">+</div>

    <div id="bottleModal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><h2 id="modalTitle">Ajouter une bouteille</h2><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <form id="bottleForm" onsubmit="saveBottle(event)">
          <div class="form-group">
            <label>üì∏ Photo</label>
            <div class="image-upload" onclick="document.getElementById('photoInput').click()">
              <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="previewImage(event)">
              <div id="uploadText">Cliquez pour ajouter une photo</div>
              <img id="imagePreview" class="image-preview" style="display:none">
            </div>
          </div>
          <div class="form-group"><label>Nom *</label><input type="text" id="inputNom" required></div>
          <div class="form-row">
            <div class="form-group"><label>Type *</label>
              <select id="inputType" required onchange="updatePairings()">
                <option value="vin">Vin</option><option value="whisky">Whisky</option><option value="rhum">Rhum</option>
                <option value="vodka">Vodka</option><option value="gin">Gin</option><option value="cognac">Cognac</option>
                <option value="biere">Bi√®re</option><option value="champagne">Champagne</option>
                <option value="liqueur">Liqueur</option><option value="autre">Autre</option>
              </select>
            </div>
            <div class="form-group"><label>Degr√© (%)</label><input type="number" id="inputDegre" step="0.1" min="0" max="100"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Volume (ml) *</label><input type="number" id="inputVolume" required></div>
            <div class="form-group"><label>Nombre</label><input type="number" id="inputNombre" value="1" min="1"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Prix (‚Ç¨)</label><input type="number" id="inputPrix" step="0.01" min="0"></div>
            <div class="form-group"><label>Date d'achat</label><input type="date" id="inputDateAchat"></div>
          </div>
          <div class="form-group"><label>Pays / R√©gion</label><input type="text" id="inputPays" placeholder="Ex: France, Bordeaux"></div>
          <div class="form-group"><label>Mill√©sime</label><input type="number" id="inputMillesime" min="1900" max="2030"></div>
          <div class="form-group"><label>Commentaire</label><textarea id="inputCommentaire" rows="3"></textarea></div>
          <div class="form-group" id="pairingsSection" style="display:none">
            <label>üçΩÔ∏è Accords mets recommand√©s</label>
            <ul class="pairing-list" id="pairingsList"></ul>
          </div>
          <div class="actions">
            <button type="button" onclick="deleteBottle()" class="btn-danger" id="deleteBtn" style="display:none">Supprimer</button>
            <button type="button" onclick="closeModal()" class="btn-secondary">Annuler</button>
            <button type="submit">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>

    <div id="scanModal" class="modal">
      <div class="modal-content">
        <div class="modal-header"><h2>üì∑ Scanner un code-barre</h2><button class="close-btn" onclick="closeScanModal()">√ó</button></div>
        <div style="text-align:center;">
          <video id="scannerVideo" style="width:100%;max-width:400px;border-radius:8px;background:#000;"></video>
          <div id="scanResult" style="margin-top:1rem;color:var(--success);"></div>
          <button onclick="closeScanModal()" class="btn-secondary" style="margin-top:1rem;">Annuler</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration Supabase - REMPLACE PAR TES VRAIES CL√âS
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    
    // V√©rification du chargement de Supabase
    if (typeof supabase === 'undefined') {
      console.error('‚ùå Supabase non charg√© !');
      alert('Erreur de chargement. Rechargez la page.');
    }
    
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let currentUser = null, allBottles = [], editingBottleId = null, uploadedPhoto = null;
    let scannerStream = null;
    let codeReader = null;
    let charts = {};
    
    const FOOD_PAIRINGS = {
      vin: ['Viandes rouges', 'Fromages affin√©s', 'Gibier', 'Plats en sauce'],
      whisky: ['Chocolat noir', 'Cigares', 'Fruits secs', 'Fromages cors√©s'],
      rhum: ['Desserts au chocolat', 'Fruits tropicaux', 'Cigares'],
      vodka: ['Caviar', 'Poissons fum√©s', 'Zakouski'],
      gin: ['Poissons grill√©s', 'Fruits de mer', 'Salades'],
      cognac: ['Chocolat', 'Foie gras', 'Cigares', 'Fromages bleus'],
      biere: ['Burgers', 'Pizzas', 'Saucisses', 'Fromages doux'],
      champagne: ['Fruits de mer', 'Caviar', 'Fromages √† p√¢te molle', 'Desserts l√©gers'],
      liqueur: ['Desserts', 'Glaces', 'Caf√©'], autre: ['√Ä d√©guster selon vos pr√©f√©rences']
    };

    async function init() {
      console.log('üöÄ Init app...');
      
      // Debug visuel sur mobile
      const debugDiv = document.createElement('div');
      debugDiv.id = 'mobileDebug';
      debugDiv.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:black;color:lime;padding:10px;font-size:10px;max-height:100px;overflow:auto;z-index:9999;display:none;';
      document.body.appendChild(debugDiv);
      
      window.onerror = (msg, url, line) => {
        debugDiv.style.display = 'block';
        debugDiv.innerHTML += `<br>‚ùå ${msg} (${line})`;
      };
      
      const { data: { session } } = await supabaseClient.auth.getSession();
      console.log('Session:', session ? 'OK' : 'Aucune');
      
      session ? (currentUser = session.user, showMainApp()) : showAuthScreen();
      supabaseClient.auth.onAuthStateChange((e, s) => {
        console.log('Auth change:', e);
        s ? (currentUser = s.user, showMainApp()) : showAuthScreen();
      });
      requestNotificationPermission();
    }

    function showAuthScreen() {
      document.getElementById('authScreen').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
    }

    function showMainApp() {
      console.log('üì± Affichage app principale');
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      console.log('üë§ User:', currentUser.email);
      loadBottles(); 
      checkAlerts();
    }

    async function signup() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const errorDiv = document.getElementById('authError');
      
      // Validation
      if (!email || !email.includes('@')) {
        errorDiv.textContent = '‚ùå Email invalide';
        errorDiv.style.color = 'var(--danger)';
        return;
      }
      if (password.length < 6) {
        errorDiv.textContent = '‚ùå Mot de passe trop court (min. 6 caract√®res)';
        errorDiv.style.color = 'var(--danger)';
        return;
      }
      
      errorDiv.textContent = '‚è≥ Cr√©ation du compte...';
      errorDiv.style.color = 'var(--warning)';
      
      console.log('Tentative signup avec:', email);
      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      
      if (error) {
        console.error('Erreur signup:', error);
        errorDiv.textContent = '‚ùå ' + error.message;
        errorDiv.style.color = 'var(--danger)';
      } else {
        console.log('Signup r√©ussi:', data);
        errorDiv.textContent = '‚úÖ Compte cr√©√© ! V√©rifiez votre email (ou connectez-vous directement si confirmation d√©sactiv√©e)';
        errorDiv.style.color = 'var(--success)';
      }
    }

    async function login() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const errorDiv = document.getElementById('authError');
      
      if (!email || !password) {
        errorDiv.textContent = '‚ùå Email et mot de passe requis';
        errorDiv.style.color = 'var(--danger)';
        return;
      }
      
      errorDiv.textContent = '‚è≥ Connexion...';
      errorDiv.style.color = 'var(--warning)';
      
      console.log('Tentative login avec:', email);
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      
      if (error) {
        console.error('Erreur login:', error);
        errorDiv.textContent = '‚ùå ' + error.message;
        errorDiv.style.color = 'var(--danger)';
      } else {
        console.log('Login r√©ussi:', data);
      }
    }

    async function logout() { 
      console.log('üö™ D√©connexion...');
      try {
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
          console.error('Erreur logout:', error);
          alert('Erreur de d√©connexion: ' + error.message);
        } else {
          console.log('‚úÖ D√©connect√©');
          // Force reload pour √™tre s√ªr
          window.location.reload();
        }
      } catch (err) {
        console.error('Exception logout:', err);
        alert('Erreur: ' + err.message);
      }
    }

    async function loadBottles() {
      console.log('üîç Chargement des bouteilles...');
      console.log('User ID:', currentUser?.id);
      
      const { data, error } = await supabaseClient.from('bouteilles').select('*').order('created_at', { ascending: false });
      
      console.log('üì¶ Donn√©es re√ßues:', data);
      console.log('‚ùå Erreur:', error);
      
      if (error) return console.error(error);
      allBottles = data || [];
      
      console.log('‚úÖ Nombre de bouteilles:', allBottles.length);
      
      displayBottles(allBottles);
      updateStats(allBottles);
    }

    function displayBottles(bottles) {
      const c = document.getElementById('bottlesContainer');
      if (!bottles.length) {
        c.innerHTML = '<div style="text-align:center;padding:4rem 2rem;color:var(--text-dim);"><div style="font-size:5rem;margin-bottom:1rem;">üçæ</div><h2>Votre cave est vide</h2><p>Ajoutez votre premi√®re bouteille avec le bouton +</p></div>';
        return;
      }
      c.innerHTML = ''; c.className = 'bottles-grid';
      bottles.forEach(b => {
        const percent = (b.volume_restant_ml / b.volume_ml * 100).toFixed(0);
        const emoji = {vin:'üç∑',whisky:'ü•É',rhum:'ü•É',vodka:'üç∏',gin:'üç∏',biere:'üç∫',champagne:'üçæ',liqueur:'üçπ',cognac:'ü•É'}[b.type_alcool]||'üçæ';
        const needsAlert = b.statut==='ouverte' && b.date_ouverture && b.duree_conservation_jours && 
          (new Date() - new Date(b.date_ouverture))/86400000 >= b.duree_conservation_jours*0.8;
        
        c.innerHTML += `
          <div class="bottle-card" onclick="openEditModal(${JSON.stringify(b).replace(/"/g, '&quot;')})">
            <div class="bottle-image">
              ${b.photo_url ? `<img src="${b.photo_url}">` : emoji}
              <div class="bottle-status status-${b.statut}">${b.statut}</div>
              ${needsAlert ? '<div class="bottle-alert">‚ö†Ô∏è √Ä boire</div>' : ''}
            </div>
            <div class="bottle-content">
              <div class="bottle-name">${b.nom}</div>
              <div class="bottle-type">${b.type_alcool.toUpperCase()}${b.sous_type ? ' ‚Ä¢ '+b.sous_type : ''}</div>
              <div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div>
              <div class="bottle-details">
                <span>${b.volume_restant_ml}/${b.volume_ml} ml</span>
                <span>${b.nombre_bouteilles}x</span>
                ${b.prix_achat ? `<span>${b.prix_achat} ‚Ç¨</span>` : ''}
              </div>
            </div>
          </div>`;
      });
    }

    function filterBottles() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const type = document.getElementById('filterType').value;
      const status = document.getElementById('filterStatus').value;
      const filtered = allBottles.filter(b => 
        (!search || b.nom.toLowerCase().includes(search)) &&
        (!type || b.type_alcool === type) &&
        (!status || b.statut === status)
      );
      displayBottles(filtered);
    }

    function updateStats(bottles) {
      document.getElementById('statTotal').textContent = bottles.length;
      document.getElementById('statValue').textContent = bottles.reduce((s,b) => s+(b.prix_achat||0)*b.nombre_bouteilles,0).toFixed(2)+' ‚Ç¨';
      document.getElementById('statVolume').textContent = (bottles.reduce((s,b) => s+b.volume_restant_ml,0)/1000).toFixed(1)+' L';
      document.getElementById('statOpen').textContent = bottles.filter(b => b.statut==='ouverte').length;
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(tab+'Tab').classList.add('active');
      if (tab === 'stats') createCharts();
      if (tab === 'alerts') checkAlerts();
      if (tab === 'account') loadProfile();
    }

    function createCharts() {
      const types = {};
      allBottles.forEach(b => types[b.type_alcool] = (types[b.type_alcool]||0) + 1);
      
      if (charts.type) charts.type.destroy();
      charts.type = new Chart(document.getElementById('typeChart'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(types),
          datasets: [{
            data: Object.values(types),
            backgroundColor: ['#8f5e26','#c49a6c','#ff9800','#4caf50','#2196f3','#9c27b0','#f44336','#00bcd4']
          }]
        },
        options: { responsive: true, plugins: { legend: { labels: { color: '#e0e0e0' } } } }
      });

      const sortedByValue = [...allBottles].sort((a,b) => (b.prix_achat||0)-(a.prix_achat||0)).slice(0,10);
      if (charts.top) charts.top.destroy();
      charts.top = new Chart(document.getElementById('topChart'), {
        type: 'bar',
        data: {
          labels: sortedByValue.map(b => b.nom.substring(0,20)),
          datasets: [{
            label: 'Prix (‚Ç¨)',
            data: sortedByValue.map(b => b.prix_achat||0),
            backgroundColor: '#8f5e26'
          }]
        },
        options: { responsive: true, scales: { y: { ticks: { color: '#e0e0e0' } }, x: { ticks: { color: '#e0e0e0' } } }, plugins: { legend: { labels: { color: '#e0e0e0' } } } }
      });

      const byMonth = {};
      allBottles.forEach(b => {
        if (b.date_achat) {
          const m = b.date_achat.substring(0,7);
          byMonth[m] = (byMonth[m]||0) + (b.prix_achat||0);
        }
      });
      const months = Object.keys(byMonth).sort();
      if (charts.value) charts.value.destroy();
      charts.value = new Chart(document.getElementById('valueChart'), {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: 'Valeur cumul√©e (‚Ç¨)',
            data: months.map((m,i) => months.slice(0,i+1).reduce((s,k) => s+byMonth[k],0)),
            borderColor: '#c49a6c',
            backgroundColor: 'rgba(196,154,108,0.1)',
            tension: 0.4
          }]
        },
        options: { responsive: true, scales: { y: { ticks: { color: '#e0e0e0' } }, x: { ticks: { color: '#e0e0e0' } } }, plugins: { legend: { labels: { color: '#e0e0e0' } } } }
      });
    }

    async function checkAlerts() {
      const alerts = [];
      allBottles.forEach(b => {
        if (b.statut === 'ouverte' && b.date_ouverture && b.duree_conservation_jours) {
          const days = (new Date() - new Date(b.date_ouverture))/86400000;
          if (days >= b.duree_conservation_jours * 0.8) {
            alerts.push({type:'warning', text:`‚ö†Ô∏è ${b.nom} : ouvert depuis ${Math.floor(days)} jours`});
          }
        }
        if (b.volume_restant_ml < b.volume_ml * 0.2) {
          alerts.push({type:'info', text:`üìâ ${b.nom} : bient√¥t vide (${((b.volume_restant_ml/b.volume_ml)*100).toFixed(0)}%)`});
        }
      });
      
      const c = document.getElementById('alertsContainer');
      if (!alerts.length) {
        c.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--text-dim);"><div style="font-size:4rem;">‚úÖ</div><h3>Aucune alerte</h3><p>Votre cave est en parfait √©tat</p></div>';
      } else {
        c.innerHTML = alerts.map(a => `<div class="alert-card">${a.text}</div>`).join('');
      }
    }

    function toggleFabMenu() {
      const menu = document.getElementById('fabMenu');
      const btn = document.getElementById('fabBtn');
      menu.classList.toggle('active');
      btn.style.transform = menu.classList.contains('active') ? 'rotate(45deg)' : 'rotate(0)';
    }

    function closeFabMenu() {
      document.getElementById('fabMenu').classList.remove('active');
      document.getElementById('fabBtn').style.transform = 'rotate(0)';
    }

    function openAddModal() {
      editingBottleId = null;
      uploadedPhoto = null;
      document.getElementById('modalTitle').textContent = 'Ajouter une bouteille';
      document.getElementById('bottleForm').reset();
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('uploadText').textContent = 'Cliquez pour ajouter une photo';
      document.getElementById('deleteBtn').style.display = 'none';
      document.getElementById('bottleModal').classList.add('active');
      updatePairings();
    }

    function openEditModal(bottle) {
      editingBottleId = bottle.id;
      uploadedPhoto = null;
      document.getElementById('modalTitle').textContent = 'Modifier la bouteille';
      document.getElementById('inputNom').value = bottle.nom;
      document.getElementById('inputType').value = bottle.type_alcool;
      document.getElementById('inputDegre').value = bottle.degre_alcool||'';
      document.getElementById('inputVolume').value = bottle.volume_ml;
      document.getElementById('inputNombre').value = bottle.nombre_bouteilles;
      document.getElementById('inputPrix').value = bottle.prix_achat||'';
      document.getElementById('inputDateAchat').value = bottle.date_achat||'';
      document.getElementById('inputPays').value = bottle.pays||'';
      document.getElementById('inputMillesime').value = bottle.millesime||'';
      document.getElementById('inputCommentaire').value = bottle.commentaire||'';
      document.getElementById('inputCodeBarre').value = bottle.code_barre||'';
      
      if (bottle.photo_url) {
        document.getElementById('imagePreview').src = bottle.photo_url;
        document.getElementById('imagePreview').style.display = 'block';
        document.getElementById('uploadText').textContent = 'Modifier la photo';
      } else {
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('uploadText').textContent = 'Cliquez pour ajouter une photo';
      }
      
      document.getElementById('deleteBtn').style.display = 'block';
      document.getElementById('bottleModal').classList.add('active');
      updatePairings();
    }

    function closeModal() {
      document.getElementById('bottleModal').classList.remove('active');
    }

    function updatePairings() {
      const type = document.getElementById('inputType').value;
      const pairings = FOOD_PAIRINGS[type] || [];
      const list = document.getElementById('pairingsList');
      const section = document.getElementById('pairingsSection');
      
      if (pairings.length) {
        list.innerHTML = pairings.map(p => `<li class="pairing-item">${p}</li>`).join('');
        section.style.display = 'block';
      } else {
        section.style.display = 'none';
      }
    }

    async function previewImage(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      uploadedPhoto = file;
      const reader = new FileReader();
      reader.onload = (ev) => {
        document.getElementById('imagePreview').src = ev.target.result;
        document.getElementById('imagePreview').style.display = 'block';
        document.getElementById('uploadText').textContent = 'Modifier la photo';
      };
      reader.readAsDataURL(file);
    }

    async function uploadPhoto(file) {
      const fileName = `${Date.now()}_${file.name}`;
      const { data, error } = await supabaseClient.storage.from('bouteilles-photos').upload(fileName, file);
      if (error) throw error;
      const { data: { publicUrl } } = supabaseClient.storage.from('bouteilles-photos').getPublicUrl(fileName);
      return publicUrl;
    }

    async function saveBottle(e) {
      e.preventDefault();
      
      let photoUrl = null;
      if (uploadedPhoto) {
        try {
          photoUrl = await uploadPhoto(uploadedPhoto);
        } catch (err) {
          console.error('Erreur upload photo:', err);
        }
      }

      const bottleData = {
        nom: document.getElementById('inputNom').value,
        type_alcool: document.getElementById('inputType').value,
        degre_alcool: document.getElementById('inputDegre').value || null,
        volume_ml: parseInt(document.getElementById('inputVolume').value),
        nombre_bouteilles: parseInt(document.getElementById('inputNombre').value),
        prix_achat: document.getElementById('inputPrix').value || null,
        date_achat: document.getElementById('inputDateAchat').value || null,
        pays: document.getElementById('inputPays').value || null,
        millesime: document.getElementById('inputMillesime').value || null,
        commentaire: document.getElementById('inputCommentaire').value || null,
        code_barre: document.getElementById('inputCodeBarre').value || null,
        user_id: currentUser.id
      };

      if (photoUrl) bottleData.photo_url = photoUrl;

      let error;
      if (editingBottleId) {
        delete bottleData.user_id;
        ({ error } = await supabaseClient.from('bouteilles').update(bottleData).eq('id', editingBottleId));
      } else {
        bottleData.volume_restant_ml = bottleData.volume_ml;
        bottleData.statut = 'scellee';
        ({ error } = await supabaseClient.from('bouteilles').insert([bottleData]));
      }

      if (error) return alert('Erreur: ' + error.message);
      
      showNotification(editingBottleId ? 'Bouteille mise √† jour !' : 'Bouteille ajout√©e !');
      closeModal();
      loadBottles();
    }

    async function deleteBottle() {
      if (!confirm('Supprimer cette bouteille ?')) return;
      const { error } = await supabaseClient.from('bouteilles').delete().eq('id', editingBottleId);
      if (error) return alert('Erreur: ' + error.message);
      showNotification('Bouteille supprim√©e !');
      closeModal();
      loadBottles();
    }

    async function openScanModal() {
      document.getElementById('scanModal').classList.add('active');
      document.getElementById('scanResult').textContent = '';
      
      const video = document.getElementById('scannerVideo');
      
      try {
        // Demander acc√®s cam√©ra
        scannerStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        
        video.srcObject = scannerStream;
        video.play();
        
        // Initialiser le lecteur de code-barre
        if (!codeReader) {
          codeReader = new ZXing.BrowserBarcodeReader();
        }
        
        // Scanner en continu
        codeReader.decodeFromVideoDevice(null, video, (result, err) => {
          if (result) {
            console.log('Code d√©tect√©:', result.text);
            document.getElementById('scanResult').textContent = '‚úÖ Code: ' + result.text;
            
            // Arr√™ter le scan et chercher le produit
            closeScanModal();
            setTimeout(() => {
              searchProductByBarcode(result.text);
            }, 300);
          }
          // Ignorer les erreurs (scan en cours)
        });
        
      } catch (err) {
        console.error('Erreur cam√©ra:', err);
        alert('Impossible d\'acc√©der √† la cam√©ra.\nV√©rifiez les permissions dans les param√®tres du navigateur.');
        closeScanModal();
      }
    }

    function closeScanModal() {
      // Arr√™ter la vid√©o
      const video = document.getElementById('scannerVideo');
      if (video && video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      
      // Arr√™ter le stream
      if (scannerStream) {
        scannerStream.getTracks().forEach(track => track.stop());
        scannerStream = null;
      }
      
      // R√©initialiser le lecteur
      if (codeReader) {
        codeReader.reset();
      }
      
      document.getElementById('scanModal').classList.remove('active');
      document.getElementById('scanResult').textContent = '';
    }

    async function searchProductByBarcode(code) {
      document.getElementById('scanResult').textContent = '‚è≥ Recherche du produit...';
      
      try {
        // Essayer Open Food Facts
        const res1 = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
        const data1 = await res1.json();
        
        if (data1.status === 1 && data1.product) {
          const p = data1.product;
          closeScanModal();
          openAddModal();
          document.getElementById('inputNom').value = p.product_name || '';
          document.getElementById('inputCodeBarre').value = code;
          document.getElementById('inputDegre').value = p.alcohol_100g || '';
          if (p.image_url) {
            document.getElementById('imagePreview').src = p.image_url;
            document.getElementById('imagePreview').style.display = 'block';
          }
          showNotification('‚úÖ Produit trouv√© !');
          return;
        }
      } catch (err1) {
        console.error('Erreur Open Food Facts:', err1);
      }
      
      try {
        // Essayer UPC Database
        const res2 = await fetch(`https://api.upcitemdb.com/prod/trial/lookup?upc=${code}`);
        const data2 = await res2.json();
        
        if (data2.items && data2.items.length > 0) {
          const item = data2.items[0];
          closeScanModal();
          openAddModal();
          document.getElementById('inputNom').value = item.title || '';
          document.getElementById('inputCodeBarre').value = code;
          document.getElementById('inputPays').value = item.brand || '';
          if (item.images && item.images.length > 0) {
            document.getElementById('imagePreview').src = item.images[0];
            document.getElementById('imagePreview').style.display = 'block';
          }
          showNotification('‚úÖ Produit trouv√© !');
          return;
        }
      } catch (err2) {
        console.error('Erreur UPC Database:', err2);
      }
      
      // Rien trouv√© - ouvrir formulaire avec code-barre
      closeScanModal();
      setTimeout(() => {
        openAddModal();
        document.getElementById('inputCodeBarre').value = code;
        showNotification('‚ö†Ô∏è Produit non trouv√©. Ajoutez les infos manuellement (code-barre: ' + code + ')');
      }, 300);
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(20);
      doc.text('Ma Cave √† Alcools', 105, 15, { align: 'center' });
      doc.setFontSize(10);
      doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, 105, 22, { align: 'center' });
      
      const tableData = allBottles.map(b => [
        b.nom,
        b.type_alcool,
        `${b.volume_restant_ml}/${b.volume_ml} ml`,
        b.nombre_bouteilles,
        b.prix_achat ? `${b.prix_achat} ‚Ç¨` : '-',
        b.statut
      ]);
      
      doc.autoTable({
        startY: 30,
        head: [['Nom', 'Type', 'Volume', 'Qt√©', 'Prix', 'Statut']],
        body: tableData,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [143, 94, 38] }
      });
      
      doc.save('ma-cave.pdf');
      showNotification('PDF export√© !');
    }

    function exportExcel() {
      const data = allBottles.map(b => ({
        Nom: b.nom,
        Type: b.type_alcool,
        'Degr√© (%)': b.degre_alcool,
        'Volume (ml)': b.volume_ml,
        'Restant (ml)': b.volume_restant_ml,
        Quantit√©: b.nombre_bouteilles,
        'Prix (‚Ç¨)': b.prix_achat,
        Statut: b.statut,
        Pays: b.pays,
        Mill√©sime: b.millesime,
        'Date achat': b.date_achat,
        Commentaire: b.commentaire
      }));
      
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Ma Cave');
      XLSX.writeFile(wb, 'ma-cave.xlsx');
      showNotification('Excel export√© !');
    }

    function showNotification(text) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.textContent = text;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function sendNotification(title, body) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { body, icon: 'üç∑' });
      }
    }

    setInterval(() => {
      allBottles.forEach(b => {
        if (b.statut === 'ouverte' && b.date_ouverture && b.duree_conservation_jours) {
          const days = (new Date() - new Date(b.date_ouverture))/86400000;
          if (Math.floor(days) === Math.floor(b.duree_conservation_jours * 0.8)) {
            sendNotification('üîî Alerte Cave', `${b.nom} devrait √™tre consomm√© rapidement !`);
          }
        }
      });
    }, 3600000);

    async function loadProfile() {
      const { data, error } = await supabaseClient
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();
      
      if (data) {
        document.getElementById('profileEmail').value = data.email;
        document.getElementById('profileUsername').value = data.username || '';
        document.getElementById('profileRole').value = data.role === 'admin' ? 'üëë Administrateur' : 'üë§ Utilisateur';
      }
    }

    async function updateProfile() {
      const username = document.getElementById('profileUsername').value;
      
      const { error } = await supabaseClient
        .from('profiles')
        .update({ username })
        .eq('id', currentUser.id);
      
      if (error) {
        alert('Erreur: ' + error.message);
      } else {
        showNotification('Profil mis √† jour !');
      }
    }

    async function changePassword() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (!newPassword || newPassword.length < 6) {
        alert('Le mot de passe doit contenir au moins 6 caract√®res');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        alert('Les mots de passe ne correspondent pas');
        return;
      }
      
      const { error } = await supabaseClient.auth.updateUser({
        password: newPassword
      });
      
      if (error) {
        alert('Erreur: ' + error.message);
      } else {
        showNotification('Mot de passe chang√© avec succ√®s !');
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
      }
    }

    async function deleteAccount() {
      if (!confirm('‚ö†Ô∏è ATTENTION : Cette action est irr√©versible !\n\nToutes vos bouteilles seront supprim√©es.\n\n√ätes-vous s√ªr de vouloir supprimer votre compte ?')) {
        return;
      }
      
      if (!confirm('Derni√®re confirmation : Voulez-vous vraiment supprimer votre compte ?')) {
        return;
      }
      
      // Supprimer l'utilisateur (cascade supprimera automatiquement les donn√©es)
      const { error } = await supabaseClient.auth.admin.deleteUser(currentUser.id);
      
      if (error) {
        // Si admin.deleteUser ne fonctionne pas, on d√©connecte juste
        alert('Contactez un administrateur pour supprimer votre compte.');
        await supabaseClient.auth.signOut();
      } else {
        showNotification('Compte supprim√©');
        await supabaseClient.auth.signOut();
      }
    }

    init();
  </script>
</body>
</html>