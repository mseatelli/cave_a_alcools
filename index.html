<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempus Vinum - PrÃ©cision Cave</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a2e, #16213e); color: #333; padding: 20px; min-height: 100vh; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden; }
        header { background: #8B0000; color: white; padding: 20px; text-align: center; }
        .tabs { display: flex; background: #f0f0f0; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border: none; font-weight: bold; }
        .tab.active { background: white; color: #8B0000; border-bottom: 3px solid #8B0000; }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        
        /* Grille */
        .cellar-grid { display: grid; gap: 8px; padding: 15px; background: #222; border-radius: 8px; }
        .cell { aspect-ratio: 1; background: #444; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; color: #ccc; text-align: center; transition: 0.2s; border: 1px solid #555; }
        .cell.filled.red { background: #8B0000; color: white; }
        .cell.filled.white { background: #F4D03F; color: #333; }
        .cell.filled.rose { background: #FF85A1; color: white; }
        .cell.filled.champagne { background: #D4AF37; color: #333; }
        .cell.vide { opacity: 0.3; filter: grayscale(1); }

        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 5px solid #8B0000; }
        
        /* Formulaire */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .range-container { background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 5px; display: none; }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 500px; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-main { background: #8B0000; color: white; }
    </style>
</head>
<body>

<div class="container">
    <header><h1>Tempus Vinum</h1></header>
    <div class="tabs">
        <div class="tab active" onclick="showTab('cellar')">Cave</div>
        <div class="tab" onclick="showTab('inventory')">Collection</div>
        <div class="tab" onclick="showTab('config')">Config</div>
    </div>

    <div id="cellar" class="tab-content active">
        <div class="stats">
            <div class="stat-card"><h3 id="stat-total">0</h3><p>UnitÃ©s</p></div>
            <div class="stat-card"><h4 id="stat-volume">0.00 L</h4><p>Restant</p></div>
            <div class="stat-card"><h4 id="stat-value">0â‚¬</h4><p>Valeur</p></div>
        </div>
        <button class="btn-main" style="width:100%; margin-bottom:15px;" onclick="quickScan()">ðŸ“· Scanner un vin</button>
        <div id="grid-main" class="cellar-grid"></div>
    </div>

    <div id="inventory" class="tab-content">
        <div id="inventory-list"></div>
    </div>

    <div id="config" class="tab-content">
        <label>Colonnes de la cave</label>
        <input type="number" id="cfg-cols" value="6" onchange="updateConfig()">
        <br><br>
        <button onclick="exportData()">ðŸ“¤ Exporter JSON</button>
    </div>
</div>

<div id="wineModal" class="modal">
    <div class="modal-content">
        <form id="wineForm">
            <input type="hidden" id="f-pos">
            <div class="form-group"><label>Domaine</label><input type="text" id="f-domaine" required></div>
            <div class="form-row" style="display:flex; gap:10px;">
                <div class="form-group" style="flex:1"><label>Contenance (ml)</label><input type="number" id="f-volume" value="750"></div>
                <div class="form-group" style="flex:1">
                    <label>Couleur</label>
                    <select id="f-couleur">
                        <option value="red">Rouge</option>
                        <option value="white">Blanc</option>
                        <option value="rose">RosÃ©</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Ã‰tat de conservation</label>
                <select id="f-status" onchange="toggleRange()">
                    <option value="sealed">ScellÃ©e (100%)</option>
                    <option value="open">Ouverte (Sur mesure)</option>
                    <option value="empty">Vide (0%)</option>
                </select>
            </div>
            <div id="range-box" class="range-container">
                <label>Niveau de remplissage : <span id="range-val">50</span>%</label>
                <input type="range" id="f-percent" min="1" max="99" value="50" oninput="document.getElementById('range-val').innerText=this.value">
            </div>
            <div class="form-group"><label>Prix (â‚¬)</label><input type="number" id="f-prix" step="0.01"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button type="submit" class="btn-main">Enregistrer</button>
                <button type="button" onclick="deleteWine()" style="background:#ddd">Supprimer</button>
                <button type="button" onclick="closeModal()" style="background:#eee">Fermer</button>
            </div>
        </form>
    </div>
</div>

<script>
    let db = { config: { rows: 5, cols: 6 }, wines: {} };

    window.onload = () => {
        const saved = localStorage.getItem('tv_v4');
        if(saved) db = JSON.parse(saved);
        renderAll();
    };

    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'inventory') renderInventory();
    }

    function toggleRange() {
        const status = document.getElementById('f-status').value;
        document.getElementById('range-box').style.display = (status === 'open') ? 'block' : 'none';
    }

    function renderAll() {
        const grid = document.getElementById('grid-main');
        grid.innerHTML = '';
        grid.style.gridTemplateColumns = `repeat(${db.config.cols}, 1fr)`;
        for(let i=0; i < (db.config.rows * db.config.cols); i++) {
            const wine = db.wines[i];
            const cell = document.createElement('div');
            cell.className = 'cell' + (wine ? ` filled ${wine.couleur}` : '') + (wine?.status === 'empty' ? ' vide' : '');
            cell.innerHTML = wine ? `<b>${wine.domaine}</b><br>${wine.percent}%` : i+1;
            cell.onclick = () => openModal(i);
            grid.appendChild(cell);
        }
        updateStats();
        localStorage.setItem('tv_v4', JSON.stringify(db));
    }

    function updateStats() {
        let volTotal = 0, valTotal = 0;
        Object.values(db.wines).forEach(w => {
            volTotal += (w.volume * w.percent / 100);
            valTotal += parseFloat(w.prix || 0);
        });
        document.getElementById('stat-total').innerText = Object.keys(db.wines).length;
        document.getElementById('stat-volume').innerText = (volTotal / 1000).toFixed(2) + " L";
        document.getElementById('stat-value').innerText = valTotal.toFixed(2) + " â‚¬";
    }

    function openModal(pos) {
        document.getElementById('wineForm').reset();
        document.getElementById('f-pos').value = pos;
        const wine = db.wines[pos];
        if(wine) {
            document.getElementById('f-domaine').value = wine.domaine;
            document.getElementById('f-volume').value = wine.volume;
            document.getElementById('f-couleur').value = wine.couleur;
            document.getElementById('f-status').value = wine.status;
            document.getElementById('f-percent').value = wine.percent;
            document.getElementById('f-prix').value = wine.prix;
            document.getElementById('range-val').innerText = wine.percent;
        }
        toggleRange();
        document.getElementById('wineModal').classList.add('active');
    }

    document.getElementById('wineForm').onsubmit = (e) => {
        e.preventDefault();
        const pos = document.getElementById('f-pos').value;
        const status = document.getElementById('f-status').value;
        let pct = 100;
        if(status === 'open') pct = document.getElementById('f-percent').value;
        if(status === 'empty') pct = 0;

        db.wines[pos] = {
            domaine: document.getElementById('f-domaine').value,
            volume: document.getElementById('f-volume').value,
            couleur: document.getElementById('f-couleur').value,
            status: status,
            percent: pct,
            prix: document.getElementById('f-prix').value
        };
        closeModal(); renderAll();
    };

    function renderInventory() {
        const list = document.getElementById('inventory-list');
        list.innerHTML = '';
        Object.values(db.wines).forEach(w => {
            const div = document.createElement('div');
            div.style = "padding:10px; border-bottom:1px solid #eee";
            div.innerHTML = `<strong>${w.domaine}</strong> - ${w.percent}% restant (${(w.volume * w.percent / 100)}ml)`;
            list.appendChild(div);
        });
    }

    function deleteWine() { delete db.wines[document.getElementById('f-pos').value]; closeModal(); renderAll(); }
    function closeModal() { document.getElementById('wineModal').classList.remove('active'); }
    function updateConfig() { db.config.cols = document.getElementById('cfg-cols').value; renderAll(); }
    function exportData() { window.open("data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db))); }
    
    async function quickScan() {
        const code = prompt("Code-barres ?");
        if(!code) return;
        let p = -1; for(let i=0; i<30; i++) { if(!db.wines[i]) { p=i; break; } }
        if(p!==-1) openModal(p);
    }
</script>
</body>
</html>
